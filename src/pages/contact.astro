---
import SiteLayout from "../layouts/SiteLayout.astro";

const FORMSPREE_ENDPOINT = "https://formspree.io/f/xzdgvplz";
---

<SiteLayout title="Contact | Eckman Designs" description="Request a consultation and share inspiration.">
  <section class="py-14 sm:py-18">
    <div class="mx-auto max-w-3xl">
      <p class="text-xs tracking-widest text-navy-900/50">CONTACT</p>
      <h1 class="mt-3 text-4xl font-semibold tracking-tight text-navy-900 sm:text-5xl">
        Request an appointment
      </h1>
      <p class="mt-4 text-navy-900/70">
        Share a few details and (optionally) upload inspiration photos. We’ll reply to schedule a consultation.
      </p>

      <div class="mt-10 rounded-[2rem] border border-black/5 bg-white p-7 shadow-soft sm:p-9">
        <form
          id="contact-form"
          action={FORMSPREE_ENDPOINT}
          method="POST"
          enctype="multipart/form-data"
          class="grid gap-5"
        >
          <div class="grid gap-5 sm:grid-cols-2">
            <label class="grid gap-2">
              <span class="text-sm font-medium text-navy-900">Name</span>
              <input
                name="name"
                required
                class="h-11 rounded-xl border border-black/10 px-4 text-navy-900 outline-none ring-0 focus:border-gold"
                placeholder="Your name"
              />
            </label>

            <label class="grid gap-2">
              <span class="text-sm font-medium text-navy-900">Phone</span>
              <input
                name="phone"
                type="tel"
                required
                class="h-11 rounded-xl border border-black/10 px-4 text-navy-900 outline-none focus:border-gold"
                placeholder="(555) 555-5555"
              />
            </label>
          </div>

          <label class="grid gap-2">
            <span class="text-sm font-medium text-navy-900">Email</span>
            <input
              name="email"
              type="email"
              required
              class="h-11 rounded-xl border border-black/10 px-4 text-navy-900 outline-none focus:border-gold"
              placeholder="you@email.com"
            />
          </label>

          <label class="grid gap-2">
            <span class="text-sm font-medium text-navy-900">Describe what you’d like</span>
            <textarea
              name="description"
              required
              rows="6"
              class="rounded-xl border border-black/10 px-4 py-3 text-navy-900 outline-none focus:border-gold"
              placeholder="Ex: I want an oval solitaire with hidden halo in yellow gold…"
            />
          </label>

          <label class="grid gap-2">
            <span class="text-sm font-medium text-navy-900">
              Inspiration images (optional)
            </span>
            <input
              id="images"
              name="images"
              type="file"
              accept="image/jpeg,image/png,image/webp"
              multiple
              class="block w-full cursor-pointer rounded-xl border border-black/10 bg-white px-4 py-3 text-sm text-navy-900/80 file:mr-4 file:rounded-full file:border-0 file:bg-navy-800 file:px-4 file:py-2 file:text-sm file:font-medium file:text-white hover:file:bg-navy-700"
            />
            <span class="text-xs text-navy-900/50">
              Optional: upload up to <strong>3</strong> images, under <strong>5MB</strong> each. (Screenshots work great.)
            </span>
          </label>

          <input type="hidden" name="_subject" value="New Eckman Designs Appointment Request" />
          <input type="hidden" name="_format" value="plain" />

          <button
            type="submit"
            class="mt-2 inline-flex h-11 items-center justify-center rounded-full bg-navy-800 px-6 text-sm font-medium text-white shadow-soft hover:bg-navy-700"
          >
            Send Request
          </button>

          <p class="text-xs text-navy-900/50">
            By submitting, you agree to be contacted to schedule your consultation.
          </p>

          <p id="form-error" class="text-red-600 text-sm mt-2 hidden">
            Something went wrong. Please try again.
          </p>
        </form>

        <div id="thank-you-message" class="hidden py-12 text-center">
          <h2 class="text-2xl font-semibold text-navy-900 mb-2">Thank you!</h2>
          <p class="text-navy-900/70">Your request has been received. We’ll be in touch soon to schedule your consultation.</p>
        </div>
      </div>
    </div>
  </section>
</SiteLayout>

<script is:inline>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('contact-form');
  const thankYou = document.getElementById('thank-you-message');
  const errorMsg = document.getElementById('form-error');
  const fileInput = document.getElementById('images');
  const MAX_FILES = 3;
  const MAX_MB_PER_FILE = 5;
  const ALLOWED_TYPES = new Set(["image/jpeg", "image/png", "image/webp"]);

  function showError(message) {
    if (!errorMsg) return;
    errorMsg.textContent = message;
    errorMsg.classList.remove('hidden');
  }

  function hideError() {
    if (!errorMsg) return;
    errorMsg.classList.add('hidden');
  }

  function validateFiles() {
    if (!fileInput || !fileInput.files) return true;

    const files = Array.from(fileInput.files);
    if (files.length === 0) return true;

    if (files.length > MAX_FILES) {
      showError(`Please upload up to ${MAX_FILES} images.`);
      fileInput.value = "";
      return false;
    }

    for (const f of files) {
      if (!ALLOWED_TYPES.has(f.type)) {
        showError("Please upload only JPG, PNG, or WEBP images.");
        fileInput.value = "";
        return false;
      }

      const sizeMb = f.size / (1024 * 1024);
      if (sizeMb > MAX_MB_PER_FILE) {
        showError(`Each image must be under ${MAX_MB_PER_FILE}MB. Try a screenshot or smaller photo.`);
        fileInput.value = "";
        return false;
      }
    }

    return true;
  }
  if (fileInput) {
    fileInput.addEventListener("change", () => {
      hideError();
      validateFiles();
    });
  }

  if (form) {
    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      hideError();

      // Validate uploads before sending
      if (!validateFiles()) return;

      const formData = new FormData(form);

      try {
        const res = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: { Accept: 'application/json' },
        });

        if (res.ok) {
          form.classList.add('hidden');
          thankYou.classList.remove('hidden');
          form.reset();
        } else {
          showError("Something went wrong submitting the form. Please try again.");
        }
      } catch {
        showError("Network error. Please try again in a moment.");
      }
    });
  }
});
</script>
